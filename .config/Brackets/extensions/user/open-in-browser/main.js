define(function(require,exports,module){"use strict";var w=window,d=w.document,MainViewManager=brackets.getModule("view/MainViewManager"),NativeApp=brackets.getModule('utils/NativeApp'),ExtensionUtils=brackets.getModule("utils/ExtensionUtils"),FileUtils=brackets.getModule("file/FileUtils"),CommandManager=brackets.getModule('command/CommandManager'),AppInit=brackets.getModule('utils/AppInit'),WorkspaceManager=brackets.getModule("view/WorkspaceManager"),PreferencesManager=brackets.getModule("preferences/PreferencesManager"),KeyBindingManager=brackets.getModule('command/KeyBindingManager'),prefs=PreferencesManager.getExtensionPrefs("open.in.browser"),Dialogs=brackets.getModule("widgets/Dialogs"),panelDialog=require('text!dialog.html'),getLocale=brackets.getLocale(),objectK="extensionFileDefault",objectCHR="extensionFileChrome",lsVersion="openInBrowser-version",lsFirstStart="openInBrowser-fs",keyid=objectK+"_keyBindingOpenInBrowser",extensions=["jpg","jpeg","gif","png","ico"],staticHtmlFileExts=["htm","html","xhtml"],serverHtmlFileExts=["php","php3","php4","php5","phtm","phtml","cfm","cfml","asp","aspx","jsp","jspx","shtm","shtml"],version=412,short="Alt-Shift-O",o={language:function(l){var titleRegister;if(/it/gi.test(l)){titleRegister="Mostra nel Browser";}else if(/es/gi.test(l)){titleRegister="Mostrar en el Navegador";}else if(/fr/gi.test(l)){titleRegister="Ouvrir dans le Navigateur";}else if(/pt/gi.test(l)){titleRegister="Abrir no Navegador";}else if(/hr/gi.test(l)){titleRegister="Otvori u web pregledniku";}else if(/de/gi.test(l)){titleRegister="Im Browser öffnen";}else{titleRegister="Open in Browser";}return titleRegister;},path:function(str){return 'file:///'+FileUtils.convertToNativePath(FileUtils.convertWindowsPathToUnixPath(str));},open:function(pth,boo){if(boo){NativeApp.openLiveBrowser(this.path(pth));}else{NativeApp.openURLInDefaultBrowser(this.path(pth));}},button:function(path,lng,boo){var self=this;$(d.createElement("a")).attr({'id':"openInBrowser_OIB",'class':"openInBrowser_OIB",'draggable':"true",'title':lng}).css({"-webkit-user-drag":"element","pointer-events":"auto"}).on("mousedown",function(e){e.stopPropagation();}).on("click",function(e){e.preventDefault();self.open(path,boo);}).on("dragstart",function(e){e.originalEvent.dataTransfer.setData('Text',path);}).appendTo("#main-toolbar .buttons");},removeButton:function(el){if($(el).length){$(el).remove();}},isArray:function(arr){if(Array.isArray==='undefined'){Array.isArray=function(){return arr instanceof Array;};}else{return Array.isArray(arr);}},hasDATA:function(oja,fli){var rx=$.inArray(fli,oja),rtrn=(rx>-1)?true:false;return rtrn;},setPrefs:function(idk,b){prefs.set(idk,b);prefs.save();},getPrefs:function(idk){return prefs.get(idk);},savePrefs:function(idk,objx){if(!this.isArray(this.getPrefs(idk))){o.setPrefs(idk,objx);}},tested:function(idk){if(undefined!==this.getPrefs(idk) &&this.isArray(this.getPrefs(idk))){return this.getPrefs(idk).join("|");}},deleteLocalStorage:function(){w.setTimeout(function(){var lsdi,lsci;for(lsdi=0;lsdi<8;lsdi+=1){if(w.localStorage.getItem("open-in-browser-firstStart"+lsdi)){w.localStorage.removeItem("open-in-browser-firstStart"+lsdi);}}for(lsci=0;lsci<3;lsci+=1){if(w.localStorage.getItem("open-in-browser-tooltip"+lsci)){w.localStorage.removeItem("open-in-browser-tooltip"+lsci);}}},50000);},firstStart:function(){o.savePrefs(objectK,extensions);o.savePrefs(objectCHR,staticHtmlFileExts.concat(serverHtmlFileExts));},features:function(){var getVersion=w.localStorage.getItem(lsVersion);if(null===getVersion||getVersion<version){Dialogs.showModalDialog("open-in-browser-dialog","Open in Browser",Mustache.render(panelDialog));w.localStorage.setItem(lsVersion,version);}},after:function(){if(null===w.localStorage.getItem(lsFirstStart)||"firstStart"!==w.localStorage.getItem(lsFirstStart)){$('<div/>').attr({'class':"openInBrowser_tooltip"}).css("top",($(".openInBrowser_OIB").offset().top+8)).html("<span>×</span>Open in Browser").click(function(){$(".openInBrowser_tooltip").remove();}).appendTo(document.body);w.localStorage.setItem(lsFirstStart,"firstStart");}},getKey:function(kbm,cid){kbm.getKeyBindings(cid);},removeKey:function(kbm,key,platform){kbm.removeBinding(key,(platform||"all"));},addKey:function(kbm,cid,shortcut,platform){kbm.addBinding(cid,shortcut,platform);},addSC:function(str,call){CommandManager.register(str,keyid,call);KeyBindingManager.addBinding(keyid,short,"all");}};ExtensionUtils.loadStyleSheet(module,"simple.css");MainViewManager.on("currentFileChange",function(){var path=MainViewManager.getCurrentlyViewedPath(MainViewManager.ACTIVE_PANE);if(typeof path==="string"){var name=path.substring(path.lastIndexOf("/")+1),regexp=new RegExp("\\.("+(o.tested(objectK)+"|"+o.tested(objectCHR))+")$","i");o.removeButton(".openInBrowser_OIB");if(path&&regexp.test(name)){o.button(path,o.language(getLocale),o.hasDATA(o.getPrefs(objectCHR),name.substring(name.lastIndexOf(".")+1)));o.after();}else{o.removeButton(".openInBrowser_OIB");}}else{o.removeButton(".openInBrowser_OIB");}});function handler(){try{var path=MainViewManager.getCurrentlyViewedPath(MainViewManager.ACTIVE_PANE);if(typeof path==="string"){var name=path.substring(path.lastIndexOf("/")+1),regexp=new RegExp("\\.("+(o.tested(objectK)+"|"+o.tested(objectCHR))+")$","i");if(regexp.test(name)){o.open(path,o.hasDATA(o.getPrefs(objectCHR),name.substring(name.lastIndexOf(".")+1)));}}}catch(err){}}AppInit.htmlReady(function(){o.features();o.firstStart();o.addSC(o.language(getLocale),handler);});AppInit.appReady(function(){o.deleteLocalStorage();});});